app-id: com.eduke32.EDuke32
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: eduke32
finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  # For storing game files
  - --filesystem=xdg-documents/EDuke32:create
  - --filesystem=xdg-documents/VoidSW:create
  # For detecting existing game files
  - --filesystem=~/.var/app/com.valvesoftware.Steam
  - --filesystem=xdg-data/Steam
  - --filesystem=~/.steam
  # Unfortunately doesn't seem to respect XDG
  - --persist=.config/eduke32
  - --persist=.config/voidsw
add-extensions:
  com.eduke32.EDuke32.DukeNukem3DShareware:
    directory: extensions
    subdirectories: false
    autodelete: true
    no-autodownload: true
modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/gtk2/gtk2.json

  - name: EDuke32
    buildsystem: simple
    build-commands:
      - make duke3d sw kenbuild -j${FLATPAK_BUILDER_N_JOBS} LF=
      - install -Dm755 -t ${FLATPAK_DEST}/bin/ eduke32 mapster32 voidsw wangulator
        ekenbuild ekenbuild-editor
      - install -Dm644 -t ${FLATPAK_DEST}/share/applications/ com.eduke32.EDuke32.desktop
        com.eduke32.EDuke32-mapster32.desktop com.eduke32.EDuke32-voidsw.desktop com.eduke32.EDuke32-wangulator.desktop
      - install -Dm644 -t ${FLATPAK_DEST}/share/appdata/ com.eduke32.EDuke32.appdata.xml
      - install -Dm644 ${FLATPAK_ID}-64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png
      - install -Dm644 ${FLATPAK_ID}-mapster32-64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${FLATPAK_ID}-mapster32.png
      - install -Dm644 ${FLATPAK_ID}-128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 ${FLATPAK_ID}-mapster32-128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}-mapster32.png
      - install -Dm644 source/sw/rsrc/game_icon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}-voidsw.svg
    post-install:
      - install -d "${FLATPAK_DEST}/extensions"
    sources:
      - type: archive
        url: https://dukeworld.com/eduke32/synthesis/20230823-10355-2e2d5f205/eduke32_src_20230823-10355-2e2d5f205.tar.xz
        sha256: 8d63fcb40e65ee39b087a9c80bec4bfe3fee26574742401ae4ad9cc4e33a4ace
        x-checker-data:
          type: html
          url: https://dukeworld.com/eduke32/synthesis/latest/
          version-pattern: eduke32_src_(\d{8}-\d+-[a-g0-9]+).tar.xz
          url-template: https://dukeworld.com/eduke32/synthesis/$version/eduke32_src_$version.tar.xz
      - type: file
        path: com.eduke32.EDuke32.appdata.xml
      - type: file
        path: com.eduke32.EDuke32.desktop
      - type: file
        path: com.eduke32.EDuke32-mapster32.desktop
      - type: file
        path: com.eduke32.EDuke32-voidsw.desktop
      - type: file
        path: com.eduke32.EDuke32-wangulator.desktop
      - type: file
        path: icons/com.eduke32.EDuke32-64.png
      - type: file
        path: icons/com.eduke32.EDuke32-mapster32-64.png
      - type: file
        path: icons/com.eduke32.EDuke32-128.png
      - type: file
        path: icons/com.eduke32.EDuke32-mapster32-128.png
